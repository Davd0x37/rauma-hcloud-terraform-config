# Hetzner Cloud Server Deployment

I've spent some time learning Terraform and cloud-init to automate the deployment of a Hetzner Cloud server. Mainly because I wanted to save 5 minutes of manual configuration on a server that I will create only once and do nothing with it.

## Disclaimer

**Use at Your Own Risk**: This configuration is provided as-is, for educational purposes and personal use. I am not responsible for any misuse, data loss, security vulnerabilities, or damages resulting from the use of this configuration. This was created solely for my personal learning and to automate server setup. Please review the code and adjust it to your needs before using it. I have no idea if this is secure or not, so please do your own research.

## HCloud CLI

There is better way to manage servers - just use [hcloud CLI](https://github.com/hetznercloud/cli)

## Description

This configuration will deploy a Hetzner Cloud server with:

- IPv4 and IPv6 (with `auto_delete` disabled for primary IPs)
- A firewall allowing traffic on a custom SSH port, as well as ports 80 and 443
- Dynamic user and SSH key management based on Terraform variables
- Server provisioning and configuration hardening performed by **Ansible**

## Prerequisites

1. Hetzner Cloud API token
2. SSH keys for admin and maintainer
3. Source IPs for firewall rules

## Links

- [Terraform](https://www.terraform.io/)
- [Hetzner Cloud](https://www.hetzner.com/cloud)
- [Hetzner Cloud API](https://docs.hetzner.cloud/) -> Everything you need to know about server types, locations etc. is there
- [Hetzner Cloud Terraform Provider](https://registry.terraform.io/providers/hetznercloud/hcloud/latest/docs)
- [Hetzner Cloud Cloud-Init](https://docs.hetzner.cloud/#servers-create-a-server)
- [Terraform hcloud provider](https://github.com/hetznercloud/terraform-provider-hcloud)

## Deployment Steps

1.  Clone this repository.
2.  Create your variables file:
    ```bash
    cp env.tfvars.example env.tfvars
    ```
3.  Edit `env.tfvars` with your values:
    - `hcloud_token`: Your Hetzner Cloud API token.
    - `server_name`: A name for your server.
    - `ssh_port`: The custom SSH port you want to use.
    - `users`: A list of user objects to be created on the server. See `env.tfvars.example` for structure and examples.
    - `firewall_source_ips`: A list of your IP addresses to allow access.
4.  Initialize Terraform:
    ```bash
    terraform init
    ```
5.  Deploy the infrastructure and run Ansible:
    ```bash
    terraform apply -var-file=env.tfvars
    ```

Note: If you use a different name for your variables file, adjust the `-var-file` parameter accordingly.

## Re-running Ansible

If you make changes to your Ansible playbooks and want to apply them to the existing server without recreating it, you can run Ansible directly:

```bash
ansible-playbook -i ansible/inventory.yml ansible/playbook.yml
```

## Server Configuration

The default configuration in `variables.tf` uses:

- Server type: CAX11 (ARM-based)
- Location: Helsinki

You can customize these by either:

1. Modifying the default values in `variables.tf`
2. Adding new variables for different server types or locations

## SSH Config Integration

To automatically use the SSH configuration generated by Terraform, add the following line to your `~/.ssh/config` file:

```
Include ~/.ssh/HCloudTerraform/config
```

This ensures that your SSH client will always use the latest server connection details managed by Terraform. If you change the output path in your Terraform configuration, update the Include path accordingly.
